from telegram import Update
from telegram.ext import CommandHandler

from src import current_bot
from src.models import User


@current_bot.register_handler(CommandHandler, ("start",))
@current_bot.log_handler
def start(update: Update, *_) -> None:
    user = update.effective_user
    db_user, created = User.get_or_create(user_id=str(user.id), username=user.username)

    if not created and db_user.subscribed:
        user.send_message("–í–∏ –≤–∂–µ –ø—ñ–¥–ø–∏—Å–∞–Ω—ñ")
        return

    if not db_user.subscribed:
        db_user.subscribed = True
        db_user.save(only=(User.subscribed,))

    user.send_message("–í—ñ—Ç–∞—é! –í–∏ –ø—ñ–¥–ø–∏—Å–∞–ª–∏—Å—è –Ω–∞ —à–∫—ñ–ª—å–Ω—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è üòä")


@current_bot.register_handler(CommandHandler, ("rules"))
@current_bot.log_handler
def rules(update: Update, *_) -> None:
    user = update.effective_user
    user.send_message(
        "<b>–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–æ–±–æ—Ç–∏ —à–∫–æ–ª–∏, –≤—Ä–∞—Ö–æ–≤—É—é—á—ñ —á–∞—Å—Ç—ñ –∞—Ç–∞–∫–∏ –Ω–∞ –ö–∏—ó–≤:</b>\n"
        "‚ñ∂Ô∏è –Ø–∫—â–æ —î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ –ö–ú–î–ê, –ú–û–ù –ø—Ä–æ —Ç–µ —â–æ —à–∫–æ–ª–∏ —É –ö–∏—î–≤—ñ –º–∞—é—Ç—å –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ "
        "–¥–∏—Å—Ç–∞–Ω—Ü—ñ–π–Ω–æ - –º–∏ –±—É–¥–µ–º–æ —É —Ü–µ–π —á–∞—Å –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –¥–∏—Å—Ç–∞–Ω—Ü—ñ–π–Ω–æ.\n"
        "‚ñ∂Ô∏è –Ø–∫—â–æ –∞–∫—Ç–∏–≤–Ω–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π –ö–ú–î–ê, –ú–û–ù –Ω–µ–º–∞—î, –∞–±–æ —à–∫–æ–ª–∏ –º–∞—é—Ç—å –ø—Ä–∞–≤–æ –ø—Ä–∏–π–º–∞—Ç–∏ "
        "—Ä—ñ—à–µ–Ω–Ω—è —â–æ–¥–æ —Ñ–æ—Ä–º–∞—Ç—É —Ä–æ–±–æ—Ç–∏ —Å–∞–º–æ—Å—Ç—ñ–π–Ω–æ, –º–∏ –±—É–¥–µ–º–æ –∫–µ—Ä—É–≤–∞—Ç–∏—Å—å –Ω–∞—Å—Ç—É–ø–Ω–∏–º:\n"
        "    ‚ñ∂Ô∏è —è–∫—â–æ —Ç—Ä–∏–≤–∞—î –ø–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞ –∑—Ä–∞–Ω–∫—É –¥–æ 8:10 –≤–∫–ª—é—á–Ω–æ - —à–∫–æ–ª–∞ –±—É–¥–µ –≤ —Ü–µ–π"
        " –¥–µ–Ω—å –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –¥–∏—Å—Ç–∞–Ω—Ü—ñ–π–Ω–æ.\n"
        "    ‚ñ∂Ô∏è —è–∫—â–æ —Ç—Ä–∏–≤–æ–≥–∞ —Ä–æ–∑–ø–æ—á–∞–ª–∞—Å—å –ø—ñ—Å–ª—è 8:10 - —É—á–Ω—ñ —Ç–∞ –≤—á–∏—Ç–µ–ª—ñ, —â–æ –≤–∂–µ –ø—Ä–∏—ó—Ö–∞–ª–∏ "
        "–≤ —à–∫–æ–ª—É –º–∞—é—Ç—å –±—É—Ç–∏ –≤ —É–∫—Ä–∏—Ç—Ç—ñ. –í —É–∫—Ä–∏—Ç—Ç—ñ –±—É–¥–µ –ø—Ä–∏—Å—É—Ç–Ω—ñ–π —á–µ—Ä–≥–æ–≤–∏–π –∫—É—Ä–∞—Ç–æ—Ä —à–∫–æ–ª–∏ "
        "–≤–∂–µ –∑ 8 —Ä–∞–Ω–∫—É. –í—á–∏—Ç–µ–ª—ñ, —â–æ –∑–∞—Å—Ç–∞–ª–∏ –ø–æ–≤—ñ—Ç—Ä—è–Ω—É —Ç—Ä–∏–≤–æ–≥—É –≤ –¥–æ—Ä–æ–∑—ñ –º–æ–∂—É—Ç—å "
        "–∑–∞–ª–∏—à–∞—Ç–∏—Å—å –≤ —É–∫—Ä–∏—Ç—Ç—ñ <i>(–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ –º–µ—Ç—Ä–æ –ö–ª–æ–≤—Å—å–∫–∞/–ê—Ä—Å–µ–Ω–∞–ª—å–Ω–∞)</i>, "
        "—á–∏ –¥—ñ–π—Ç–∏ –¥–æ —É–∫—Ä–∏—Ç—Ç—è –≤ —à–∫–æ–ª—ñ <i>(–Ω–∞ –≤–ª–∞—Å–Ω–∏–π —Ä–æ–∑—Å—É–¥)</i>. "
        "–ü—ñ—Å–ª—è –≤—ñ–¥–±–æ—é –º–∏ —Ä–æ–∑–ø–æ—á–∏–Ω–∞—î–º–æ –æ—á–Ω–µ –Ω–∞–≤—á–∞–Ω–Ω—è.\n"
        "    ‚ñ∂Ô∏è —è–∫—â–æ —Ç—Ä–∏–≤–æ–≥–∞ —Ä–æ–∑–ø–æ—á–∞–ª–∞—Å—å –ø—ñ—Å–ª—è 9:00, —Ç–æ –¥—ñ—î–º–æ –∑–∞ –≤–∂–µ –≤—ñ–¥–ø—Ä–∞—Ü—å–æ–≤–∞–Ω–∏–º "
        "–ø–ª–∞–Ω–æ–º - —É—Ä–æ–∫–∏ –ø—Ä–∏–∑—É–ø–∏–Ω—è—é—Ç—å—Å—è —Ç–∞ –≤—Å—ñ —Å–ø—É—Å–∫–∞—é—Ç—å—Å—è –≤ —É–∫—Ä–∏—Ç—Ç—è. –ü—ñ—Å–ª—è –≤—ñ–¥–±–æ—é –º–∏ "
        "–ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ –æ—á–Ω–µ –Ω–∞–≤—á–∞–Ω–Ω—è.\n"
    )


@current_bot.register_handler(CommandHandler, ("unsubscribe",))
@current_bot.log_handler
def unsubscribe(update: Update, *_) -> None:
    user = update.effective_user

    db_user = User.get_or_none(user_id=user.id)
    if db_user and db_user.subscribed:
        db_user.subscribed = False
        db_user.save(only=(User.subscribed,))

        user.send_message("–ü—ñ–¥–ø–∏—Å–∫—É —Å–∫–∞—Å–æ–≤–∞–Ω–æ üò¢")
        return

    user.send_message("–í–∏ –Ω–µ –±—É–ª–∏ –ø—ñ–¥–ø–∏—Å–∞–Ω—ñ")
